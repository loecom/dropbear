name: Build Dropbear for ARMv5

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-armv5:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your Dropbear fork
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          fetch-depth: 1

      - name: Install ARMv5 cross-compilation toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabi autoconf automake libtool

      - name: Download and cross-compile zlib for ARMv5
        run: |
          wget https://zlib.net/zlib-1.3.2.tar.gz
          tar -xzf zlib-1.3.2.tar.gz
          cd zlib-1.3.2
          CC=arm-linux-gnueabi-gcc ./configure --static
          make
          sudo make install prefix=/usr/arm-linux-gnueabi

      - name: Download and cross-compile libxcrypt for ARMv5
        run: |
          # 下载已生成 configure 的官方发布版
          wget https://github.com/besser82/libxcrypt/releases/download/v4.5.2/libxcrypt-4.5.2.tar.xz
          tar -xf libxcrypt-4.5.2.tar.xz
          cd libxcrypt-4.5.2
      
          # 直接 configure（已有 configure 脚本！）
          CC=arm-linux-gnueabi-gcc \
          ./configure \
            --host=arm-linux-gnueabi \
            --prefix=/usr/arm-linux-gnueabi \
            --enable-static \
            --disable-shared \
            --disable-werror
      
          make -j$(nproc)
          sudo make install

      - name: Configure for ARMv5 (soft-float, static)
        run: |
          # 使用 ARMv5 交叉编译器
          CPPFLAGS="-I/usr/arm-linux-gnueabi/include" \
          LDFLAGS="-L/usr/arm-linux-gnueabi/lib" \
          CC=arm-linux-gnueabi-gcc \
          ./configure \
            --host=arm-linux-gnueabi \
            --prefix=/tmp/dropbear-armv5 \
            --disable-lastlog \
            --disable-utmp \
            --disable-utmpx \
            --disable-wtmp \
            --disable-wtmpx \
            --disable-loginfunc \
            --disable-pututline \
            --disable-putwutline \
            --enable-static \

      - name: Compile Dropbear
        run: |
          make clean
          make PROGRAMS="dropbear dbclient dropbearkey dropbearconvert scp" -j$(nproc)

      - name: Install to staging directory
        run: |
          make PROGRAMS="dropbear dbclient dropbearkey dropbearconvert scp" install

      - name: Verify architecture of binary
        run: |
          file /tmp/dropbear-armv5/sbin/dropbear

      - name: Upload ARMv5 binaries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dropbear-armv5-binaries
          path: /tmp/dropbear-armv5/
          retention-days: 7
